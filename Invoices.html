<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mozillio - Invoice System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Reset and Global Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary: #0056ff;
  --primary-dark: #0046d4;
  --primary-light: #e8efff;
  --sidebar-width: 280px;
  --sidebar-collapsed-width: 80px;
  --white: #ffffff;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-500: #6b7280;
  --gray-700: #374151;
  --gray-900: #111827;
  --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --radius: 12px;
}

body {
  font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
  background: #f0f4f8;
  color: var(--gray-900);
  line-height: 1.6;
  overflow-x: hidden;
}

/* ------------------ Layout ------------------ */
.layout {
  display: flex;
  min-height: 100vh;
}

/* ------------------ Modern Sidebar ------------------ */
.sidebar {
  width: var(--sidebar-width);
  background: var(--white);
  border-right: 1px solid var(--gray-200);
  box-shadow: var(--shadow);
  padding: 25px 20px;
  display: flex;
  flex-direction: column;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  z-index: 100;
  transition: all 0.3s ease;
}

.sidebar-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 40px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--gray-200);
}

.sidebar-logo {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  overflow: hidden;
}

.sidebar-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.sidebar h3 {
  font-size: 22px;
  font-weight: 700;
  color: var(--primary);
  transition: opacity 0.3s ease;
}

.menu {
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex: 1;
}

.menu-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 14px 18px;
  text-decoration: none;
  color: var(--gray-700);
  font-size: 16px;
  border-radius: var(--radius);
  transition: all 0.3s ease;
  position: relative;
  cursor: pointer;
}

.menu-item:hover {
  background: var(--primary-light);
  color: var(--primary);
  transform: translateX(5px);
}

.menu-item.active {
  background: var(--primary);
  color: white;
  box-shadow: 0 4px 12px rgba(0, 86, 255, 0.2);
}

.menu-item i {
  font-size: 20px;
  width: 24px;
  text-align: center;
}

.menu-text {
  transition: opacity 0.3s ease;
}

.menu-badge {
  position: absolute;
  right: 15px;
  background: var(--primary);
  color: white;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 20px;
}

/* Dropdown Menu */
.dropdown-menu {
  display: none;
  flex-direction: column;
  gap: 4px;
  margin-left: 30px;
  margin-top: 8px;
  padding-left: 15px;
  border-left: 2px solid var(--gray-200);
}

.dropdown-menu.active {
  display: flex;
}

.dropdown-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 15px;
  text-decoration: none;
  color: var(--gray-600);
  font-size: 14px;
  border-radius: var(--radius);
  transition: all 0.3s ease;
}

.dropdown-item:hover {
  background: var(--gray-100);
  color: var(--primary);
}

.dropdown-item.active {
  background: var(--primary-light);
  color: var(--primary);
  font-weight: 500;
}

.dropdown-item i {
  font-size: 16px;
  width: 20px;
}

/* Sidebar Footer */
.sidebar-footer {
  margin-top: auto;
  padding-top: 20px;
  border-top: 1px solid var(--gray-200);
}

.footer-links {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.footer-link {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 15px;
  text-decoration: none;
  color: var(--gray-500);
  font-size: 14px;
  border-radius: var(--radius);
  transition: all 0.3s ease;
}

.footer-link:hover {
  background: var(--gray-100);
  color: var(--gray-700);
}

.footer-link i {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

/* Sidebar Toggle Button for Mobile - Only shows on mobile */
.sidebar-toggle {
  display: none;
  position: fixed;
  top: 20px;
  left: 20px;
  z-index: 1000;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  width: 40px;
  height: 40px;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow);
}

/* ------------------ Main Content ------------------ */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 0;
  transition: all 0.3s ease;
  background: #f8fafc;
}

/* ------------------ Top Header ------------------ */
.top-header {
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  padding: 25px 40px;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 20px rgba(0, 86, 255, 0.15);
}

.header-left h1 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.welcome-text {
  font-size: 16px;
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 8px;
}

.welcome-icon {
  background: rgba(255, 255, 255, 0.2);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 25px;
}

.header-icons {
  display: flex;
  gap: 15px;
}

.icon-button {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.icon-button:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ff6b6b;
  color: white;
  font-size: 10px;
  font-weight: 600;
  padding: 3px 7px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
  border: 2px solid var(--primary);
}

.user-menu {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 20px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.user-menu:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.user-menu-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.user-menu-info {
  display: flex;
  flex-direction: column;
}

.user-menu-name {
  font-weight: 600;
  font-size: 15px;
  color: white;
}

.user-menu-role {
  font-size: 13px;
  opacity: 0.8;
  color: white;
}

/* ------------------ Container ------------------ */
.container {
  max-width: 1200px;
  margin: 40px auto;
  background: var(--white);
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.08);
  padding: 40px;
  border: 1px solid var(--gray-200);
}

/* ------------------ Page Header ------------------ */
.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--gray-200);
}

.page-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--gray-900);
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-title i {
  color: var(--primary);
  font-size: 24px;
}

/* ------------------ Action Bar ------------------ */
.action-bar {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 30px;
  gap: 15px;
}

.search-box {
  flex: 1;
  max-width: 400px;
  position: relative;
}

.search-box input {
  width: 100%;
  padding: 12px 45px 12px 16px;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  font-size: 14px;
  background: var(--white);
}

.search-box i {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray-500);
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: 0 4px 15px rgba(0, 86, 255, 0.2);
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 86, 255, 0.3);
}

.btn-secondary {
  background: var(--gray-100);
  color: var(--gray-700);
  border: 1px solid var(--gray-200);
}

.btn-secondary:hover {
  background: var(--gray-200);
  transform: translateY(-1px);
}

/* ------------------ Data Table ------------------ */
.data-table-container {
  background: var(--white);
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

.data-table {
  width: 100%;
  border-collapse: collapse;
}

.data-table th {
  background: var(--gray-50);
  padding: 16px;
  text-align: left;
  font-weight: 600;
  color: var(--gray-700);
  border-bottom: 1px solid var(--gray-200);
  font-size: 14px;
}

.data-table td {
  padding: 16px;
  border-bottom: 1px solid var(--gray-200);
  font-size: 14px;
}

.data-table tr:hover {
  background: var(--gray-50);
}

.data-table tr:last-child td {
  border-bottom: none;
}

.status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-draft {
  background: #fef3c7;
  color: #d97706;
}

.status-sent {
  background: #dbeafe;
  color: #1d4ed8;
}

.status-paid {
  background: #dcfce7;
  color: #15803d;
}

.action-buttons {
  display: flex;
  gap: 8px;
}

.btn-sm {
  padding: 8px 12px;
  font-size: 12px;
  border-radius: 8px;
}

.btn-edit {
  background: #e0f2fe;
  color: #0369a1;
  border: 1px solid #bae6fd;
}

.btn-delete {
  background: #fee2e2;
  color: #dc2626;
  border: 1px solid #fecaca;
}

.btn-edit:hover, .btn-delete:hover {
  transform: translateY(-1px);
}

/* ------------------ Invoice Form Styles ------------------ */
.header-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 40px;
  padding-bottom: 25px;
  border-bottom: 2px solid var(--gray-200);
}

.logo-container {
  display: flex;
  align-items: center;
  gap: 20px;
}

.logo {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  overflow: hidden;
  box-shadow: 0 6px 20px rgba(0, 86, 255, 0.2);
}

.logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.header-text {
  display: flex;
  flex-direction: column;
}

.header-text h2 {
  text-align: left;
  color: var(--primary);
  font-size: 32px;
  font-weight: 700;
  margin-bottom: 8px;
}

.invoice-number {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-500);
  background: var(--gray-100);
  padding: 6px 12px;
  border-radius: 20px;
  display: inline-block;
}

.form-section {
  margin-bottom: 40px;
}

.section-title {
  font-weight: 700;
  font-size: 20px;
  color: var(--gray-900);
  margin: 40px 0 20px 0;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--gray-200);
  display: flex;
  align-items: center;
  gap: 10px;
}

.section-title i {
  color: var(--primary);
}

.box-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-bottom: 30px;
}

.box {
  background: var(--gray-50);
  border-radius: var(--radius);
  padding: 25px;
  border: 1px solid var(--gray-200);
  transition: all 0.3s ease;
}

.box:hover {
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
  transform: translateY(-2px);
}

.box-title {
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--primary);
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.box-title i {
  font-size: 16px;
}

.input-group {
  margin-bottom: 20px;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: var(--gray-700);
  font-size: 14px;
}

input, textarea, select {
  width: 100%;
  padding: 15px 18px;
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
  font-size: 15px;
  font-family: inherit;
  transition: all 0.3s ease;
  background: var(--white);
}

input:focus, textarea:focus, select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(0, 86, 255, 0.15);
  outline: none;
  background: var(--white);
}

.table-container {
  overflow-x: auto;
  margin-bottom: 20px;
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
  background: var(--white);
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

table th {
  padding: 18px 16px;
  text-align: left;
  font-weight: 600;
  background: var(--gray-50);
  color: var(--gray-700);
  border-bottom: 1px solid var(--gray-200);
  font-size: 14px;
}

table tbody tr {
  background: var(--white);
  transition: all 0.3s ease;
}

table tbody tr:hover {
  background: var(--gray-50);
}

table td {
  padding: 16px;
  border-bottom: 1px solid var(--gray-200);
}

table input {
  padding: 12px;
  border-radius: 8px;
  border: 1px solid var(--gray-200);
  width: 100%;
  transition: all 0.3s ease;
  background: var(--white);
}

table input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 86, 255, 0.1);
}

#addItem {
  background: var(--primary);
  color: var(--white);
  margin-bottom: 30px;
  box-shadow: 0 4px 15px rgba(0, 86, 255, 0.2);
}

#addItem:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 86, 255, 0.3);
}

.removeBtn {
  background: #ff6b6b;
  color: var(--white);
  padding: 10px 15px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
}

.removeBtn:hover {
  background: #ff5252;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
}

#downloadPdf,
button[type="submit"] {
  background: var(--primary);
  color: var(--white);
  margin-top: 20px;
  margin-right: 15px;
  box-shadow: 0 4px 15px rgba(0, 86, 255, 0.2);
}

#downloadPdf:hover,
button[type="submit"]:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 86, 255, 0.3);
}

.totals-section {
  background: linear-gradient(135deg, var(--gray-50) 0%, #f8fafc 100%);
  border-radius: var(--radius);
  padding: 25px;
  margin-bottom: 30px;
  border: 1px solid var(--gray-200);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

.totals-row {
  display: flex;
  justify-content: space-between;
  padding: 14px 0;
  border-bottom: 1px solid var(--gray-200);
  align-items: center;
}

.totals-row:last-child {
  border-bottom: none;
  font-weight: 700;
  font-size: 20px;
  color: var(--primary);
  padding-top: 20px;
  margin-top: 10px;
  border-top: 2px solid var(--gray-200);
}

.totals-label {
  color: var(--gray-700);
  font-weight: 500;
}

.totals-value {
  font-weight: 600;
  font-size: 16px;
}

/* ------------------ Page Navigation ------------------ */
.page-content {
  display: none;
}

.page-content.active {
  display: block;
}

/* ------------------ Modal Styles ------------------ */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background-color: white;
  padding: 24px;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--gray-200);
}

.modal-header h2 {
  color: #0f172a;
  font-size: 20px;
  font-weight: 600;
}

.close-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #64748b;
}

.delete-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 24px;
}

.confirm-delete-btn {
  background-color: #ef4444;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s;
}

.confirm-delete-btn:hover {
  background-color: #dc2626;
}

.cancel-btn {
  background-color: #e2e8f0;
  color: #475569;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s;
}

.cancel-btn:hover {
  background-color: #cbd5e1;
}

/* ------------------ Mobile Responsiveness ------------------ */
@media (max-width: 1024px) {
  .box-container {
    grid-template-columns: 1fr;
  }
  
  .container {
    padding: 30px;
    margin: 30px;
  }
  
  .sidebar {
    width: var(--sidebar-collapsed-width);
  }
  
  .sidebar h3,
  .menu-text,
  .menu-badge,
  .dropdown-menu {
    opacity: 0;
    visibility: hidden;
  }
  
  .main-content {
    margin-left: var(--sidebar-collapsed-width);
  }
  
  .sidebar-header {
    justify-content: center;
  }
  
  .footer-link span {
    display: none;
  }
}

@media (max-width: 768px) {
  .sidebar-toggle {
    display: flex;
  }
  
  .sidebar {
    transform: translateX(-100%);
    width: var(--sidebar-width);
  }
  
  .sidebar.active {
    transform: translateX(0);
  }
  
  .sidebar h3,
  .menu-text,
  .menu-badge,
  .dropdown-menu {
    opacity: 1;
    visibility: visible;
  }
  
  .main-content {
    margin-left: 0;
    padding: 0;
  }
  
  .container {
    padding: 20px;
    margin: 20px;
    border-radius: 15px;
  }
  
  .top-header {
    padding: 20px;
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }
  
  .header-right {
    width: 100%;
    justify-content: space-between;
  }
  
  .page-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 20px;
  }
  
  .action-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-box {
    max-width: 100%;
  }
  
  .user-menu-info {
    display: none;
  }
  
  .footer-link span {
    display: block;
  }
}

@media (max-width: 576px) {
  .container {
    padding: 15px;
    margin: 15px;
    border-radius: 12px;
  }
  
  .data-table {
    font-size: 12px;
  }
  
  .data-table th,
  .data-table td {
    padding: 12px 8px;
  }
  
  .action-buttons {
    flex-direction: column;
    gap: 4px;
  }
}

/* Overlay for mobile sidebar */
.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 99;
  display: none;
}

.sidebar-overlay.active {
  display: block;
}

/* Non-functional page styling */
.non-functional {
  text-align: center;
  padding: 60px 20px;
  color: var(--gray-500);
}

.non-functional i {
  font-size: 48px;
  margin-bottom: 20px;
  display: block;
}

.non-functional h3 {
  margin-bottom: 10px;
}

.non-functional p {
  margin-bottom: 20px;
}
</style>
</head>

<body>

<!-- Sidebar Toggle Button for Mobile - Only shows on mobile -->
<button class="sidebar-toggle" id="sidebarToggle">
  <i class="fas fa-bars"></i>
</button>

<!-- Sidebar Overlay for Mobile -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Delete Confirmation Modal -->
<div class="modal delete-modal" id="deleteModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Delete Invoice</h2>
      <button class="close-btn" id="closeDeleteModal">&times;</button>
    </div>
    <p>Are you sure you want to delete this invoice? This action cannot be undone.</p>
    <div class="delete-actions">
      <button class="cancel-btn" id="cancelDelete">Cancel</button>
      <button class="confirm-delete-btn" id="confirmDelete">Delete</button>
    </div>
  </div>
</div>

<div class="layout">
  <!-- Modern Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <img src="c:\Users\mozil\Downloads\moz logo (1).png" alt="Mozillio Logo">
      </div>
      <h3>Mozillio</h3>
    </div>

    <nav class="menu">
      <!-- Dashboard -->
      <a href="#" class="menu-item non-functional-link" data-page="dashboard">
        <i class="fas fa-tachometer-alt"></i>
        <span class="menu-text">Dashboard</span>
      </a>
      
      <!-- Sales Dropdown -->
      <div class="menu-item" id="salesMenu">
        <i class="fas fa-shopping-cart"></i>
        <span class="menu-text">Sales</span>
        <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 12px;"></i>
      </div>
      
      <div class="dropdown-menu" id="salesDropdown">
        <a href="Invoices.html" class="dropdown-item active" data-page="invoices">
          <i class="fas fa-file-invoice"></i>
          <span>Invoices</span>
        </a>
        <a href="client.html" class="dropdown-item" data-page="clients">
          <i class="fas fa-users"></i>
          <span>Clients</span>
        </a>
      </div>
      <!-- Team Menu (Simple, no dropdown) -->
    <a href="#" class="menu-item non-functional-link" data-page="team">
      <i class="fas fa-users"></i>
      <span class="menu-text">Team</span>
    </a>
      <!-- Other non-functional menu items -->
      <a href="project.html" class="menu-item non-functional-link" data-page="projects">
        <i class="fas fa-project-diagram"></i>
        <span class="menu-text">Projects</span>
      </a>
      <a href="#" class="menu-item non-functional-link" data-page="calendar">
        <i class="fas fa-calendar"></i>
        <span class="menu-text">Calendar</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="footer-links">
        <a href="#" class="footer-link">
          <i class="fas fa-shield-alt"></i>
          <span>Privacy Policy</span>
        </a>
        <a href="#" class="footer-link">
          <i class="fas fa-file-contract"></i>
          <span>Terms of Service</span>
        </a>
        <a href="#" class="footer-link">
          <i class="fas fa-question-circle"></i>
          <span>Help & Support</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Header -->
    <div class="top-header">
      <div class="header-left">
        <h1 id="pageTitle">Invoices</h1>
        <div class="welcome-text">
          <span class="welcome-icon">ðŸ‘‹</span>
          Welcome back, Alex Morgan!
        </div>
      </div>
      <div class="header-right">
        <div class="header-icons">
          <div class="icon-button">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">3</span>
          </div>
          <div class="icon-button">
            <i class="fas fa-envelope"></i>
            <span class="notification-badge">5</span>
          </div>
          <div class="icon-button">
            <i class="fas fa-cog"></i>
          </div>
        </div>
        <div class="user-menu">
          <div class="user-menu-avatar">
            AM
          </div>
          <div class="user-menu-info">
            <div class="user-menu-name">Alex Morgan</div>
            <div class="user-menu-role">Administrator</div>
          </div>
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>
    </div>

    <!-- Invoices Page -->
    <div class="container page-content active" id="invoicesPage">
      <div class="page-header">
        <div class="page-title">
          <i class="fas fa-file-invoice"></i>
          Invoices
        </div>
        <button class="btn btn-primary" id="createInvoiceBtn">
          <i class="fas fa-plus"></i>
          Create Invoice
        </button>
      </div>

      <div class="action-bar">
        <div class="search-box">
          <input type="text" placeholder="Search invoices...">
          <i class="fas fa-search"></i>
        </div>
        <button class="btn btn-secondary">
          <i class="fas fa-filter"></i>
          Filter
        </button>
        <button class="btn btn-secondary">
          <i class="fas fa-download"></i>
          Export
        </button>
      </div>

      <div class="data-table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Invoice Number</th>
              <th>Client Name</th>
              <th>Date</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="invoicesTableBody">
            <!-- Invoices will be loaded from Airtable here -->
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-500);">
                <i class="fas fa-file-invoice" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                <p>No invoices found. <a href="#" style="color: var(--primary);" id="createFirstInvoice">Create your first invoice</a></p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Create/Edit Invoice Page -->
    <div class="container page-content" id="createInvoicePage">
      <!-- Header with logo and invoice number -->
      <div class="header-section">
        <div class="logo-container">
          <div class="logo">
            <img src="c:\Users\mozil\Downloads\moz logo (1).png" alt="Mozillio Logo">
          </div>
          <div class="header-text">
            <h2 id="invoiceFormTitle">Create New Invoice</h2>
            <div class="invoice-number" id="invoiceNumberDisplay">MOZ-001</div>
          </div>
        </div>
        <button class="btn btn-secondary" id="backToInvoices">
          <i class="fas fa-arrow-left"></i>
          Back to Invoices
        </button>
      </div>

      <form id="invoiceForm">
        <!-- Invoice and Project Details in Boxes -->
        <div class="box-container">
          <div class="box">
            <div class="box-title">
              <i class="fas fa-receipt"></i>
              Invoice Details
            </div>
            <div class="input-group">
              <label for="date"><i class="fas fa-calendar"></i> Date</label>
              <input type="date" id="date" name="date" required>
            </div>
            <div class="input-group">
              <label for="validity"><i class="fas fa-clock"></i> Validity</label>
              <input type="text" id="validity" name="validity" placeholder="e.g., 30 days" required>
            </div>
            <div class="input-group">
              <label for="companyName"><i class="fas fa-building"></i> Company Name</label>
              <input type="text" id="companyName" name="companyName" placeholder="Your company name" required>
            </div>
          </div>

          <div class="box">
            <div class="box-title">
              <i class="fas fa-project-diagram"></i>
              Project Details
            </div>
            <div class="input-group">
              <label for="projectName"><i class="fas fa-tasks"></i> Project Name</label>
              <input type="text" id="projectName" name="projectName" placeholder="Project name" required>
            </div>
            <div class="input-group">
              <label for="projectDescription"><i class="fas fa-align-left"></i> Project Description</label>
              <textarea id="projectDescription" name="projectDescription" placeholder="Project description" rows="3" required></textarea>
            </div>
          </div>
        </div>

        <!-- Client Details -->
        <div class="section-title">
          <i class="fas fa-users"></i>
          Client Details
        </div>
        <div class="box">
          <div class="input-group">
            <label for="clientName"><i class="fas fa-user"></i> Client Name</label>
            <input type="text" id="clientName" name="clientName" placeholder="Client name" required>
          </div>
          <div class="input-group">
            <label for="clientEmail"><i class="fas fa-envelope"></i> Client Email</label>
            <input type="email" id="clientEmail" name="clientEmail" placeholder="Client email" required>
          </div>
          <div class="input-group">
            <label for="clientAddress"><i class="fas fa-map-marker-alt"></i> Client Address</label>
            <textarea id="clientAddress" name="clientAddress" placeholder="Client address" rows="3" required></textarea>
          </div>
        </div>

        <!-- Items Table -->
        <div class="section-title">
          <i class="fas fa-list"></i>
          Items
        </div>
        <div class="table-container">
          <table id="itemsTable">
            <thead>
              <tr>
                <th>Service/Item</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Price (RM)</th>
                <th>Discount (%)</th>
                <th>Total (RM)</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><input type="text" name="itemName[]" placeholder="Service name" required></td>
                <td><input type="text" name="itemDescription[]" placeholder="Item description" required></td>
                <td><input type="number" name="itemQty[]" value="1" min="1" required></td>
                <td><input type="number" name="itemPrice[]" value="0" min="0" step="0.01" placeholder="0.00" required></td>
                <td><input type="number" name="itemDiscount[]" value="0" min="0" max="100" step="0.01" placeholder="0.00" required></td>
                <td><input type="number" name="itemTotal[]" value="0" readonly></td>
                <td><button type="button" class="removeBtn"><i class="fas fa-trash"></i></button></td>
              </tr>
            </tbody>
          </table>
        </div>

        <button type="button" id="addItem">
          <i class="fas fa-plus"></i> Add Item
        </button>

        <!-- Totals Section -->
        <div class="section-title">
          <i class="fas fa-calculator"></i>
          Totals
        </div>
        <div class="totals-section">
          <div class="totals-row">
            <span class="totals-label">Subtotal</span>
            <span class="totals-value" id="subtotalDisplay">RM 0.00</span>
          </div>
          <div class="totals-row">
            <span class="totals-label">Total Discount</span>
            <span class="totals-value" id="totalDiscountDisplay">RM 0.00</span>
          </div>
          <div class="totals-row">
            <span class="totals-label">Tax (6%)</span>
            <span class="totals-value" id="taxDisplay">RM 0.00</span>
          </div>
          <div class="totals-row">
            <span class="totals-label">Total Amount</span>
            <span class="totals-value" id="totalDisplay">RM 0.00</span>
          </div>
        </div>

        <!-- Other Details -->
        <div class="section-title">
          <i class="fas fa-file-alt"></i>
          Other Details
        </div>
        <div class="box">
          <div class="input-group">
            <label for="paymentTerms"><i class="fas fa-handshake"></i> Payment Terms</label>
            <textarea id="paymentTerms" name="paymentTerms" placeholder="Payment terms and conditions" rows="2"></textarea>
          </div>
          <div class="input-group">
            <label for="deliveryTimeline"><i class="fas fa-shipping-fast"></i> Delivery Timeline</label>
            <input type="text" id="deliveryTimeline" name="deliveryTimeline" placeholder="Expected delivery timeline">
          </div>
          <div class="input-group">
            <label for="status"><i class="fas fa-check-circle"></i> Payment Status</label>
            <select id="status" name="status">
              <option value="Draft">Draft</option>
              <option value="Sent">Sent</option>
              <option value="Paid">Paid</option>
            </select>
          </div>
        </div>

        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
          <button type="submit" id="saveInvoiceBtn">
            <i class="fas fa-save"></i> Save Invoice
          </button>
          <button type="button" id="downloadPdf">
            <i class="fas fa-download"></i> Download PDF
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Airtable config
const AIRTABLE_BASE_ID = "app6jM5rj5GDbVvCI";
const AIRTABLE_API_KEY = "patPDSUOPn8u7HTNY.94a90bce28105c224fb2b46b5029fb17fc85daa91b5a0126ec2358637727fbe4";
const AIRTABLE_TABLE_NAME = "Invoices";

// Page Management
document.addEventListener('DOMContentLoaded', function() {
  const sidebar = document.getElementById('sidebar');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const salesMenu = document.getElementById('salesMenu');
  const salesDropdown = document.getElementById('salesDropdown');
  const pageTitle = document.getElementById('pageTitle');
  const createInvoiceBtn = document.getElementById('createInvoiceBtn');
  const backToInvoices = document.getElementById('backToInvoices');
  const createFirstInvoice = document.getElementById('createFirstInvoice');
  const deleteModal = document.getElementById('deleteModal');
  const closeDeleteModal = document.getElementById('closeDeleteModal');
  const cancelDelete = document.getElementById('cancelDelete');
  const confirmDelete = document.getElementById('confirmDelete');
  const invoiceFormTitle = document.getElementById('invoiceFormTitle');
  const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');

  // Variables to track current state
  let currentInvoiceId = null;
  let isEditMode = false;
  let currentInvoiceNumber = '';

  // Toggle sidebar on button click
  sidebarToggle.addEventListener('click', function() {
    sidebar.classList.toggle('active');
    sidebarOverlay.classList.toggle('active');
  });
  
  // Close sidebar when clicking on overlay
  sidebarOverlay.addEventListener('click', function() {
    sidebar.classList.remove('active');
    sidebarOverlay.classList.remove('active');
  });

  // Toggle sales dropdown
  salesMenu.addEventListener('click', function(e) {
    e.preventDefault();
    salesDropdown.classList.toggle('active');
    salesMenu.querySelector('.fa-chevron-down').classList.toggle('fa-chevron-up');
  });

  // Page navigation
  function navigateToPage(pageId, pageName) {
    // Hide all pages
    document.querySelectorAll('.page-content').forEach(page => {
      page.classList.remove('active');
    });
    
    // Show selected page
    document.getElementById(pageId).classList.add('active');
    
    // Update page title
    pageTitle.textContent = pageName;
    
    // Close sidebar on mobile
    if (window.innerWidth <= 768) {
      sidebar.classList.remove('active');
      sidebarOverlay.classList.remove('active');
    }

    // Load data if navigating to invoices page
    if (pageId === 'invoicesPage') {
      loadInvoicesFromAirtable();
    }
  }

  // Set up page navigation for invoices
  document.querySelectorAll('[data-page="invoices"]').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const pageId = this.getAttribute('data-page') + 'Page';
      const pageName = this.querySelector('span').textContent;
      navigateToPage(pageId, pageName);
      
      // Set active states
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelectorAll('.dropdown-item').forEach(item => {
        item.classList.remove('active');
      });
      
      if (this.classList.contains('dropdown-item')) {
        this.classList.add('active');
        this.closest('.menu-item').classList.add('active');
      } else {
        this.classList.add('active');
      }
    });
  });

  // Set up page navigation for non-functional pages
  document.querySelectorAll('.non-functional-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const pageId = this.getAttribute('data-page') + 'Page';
      const pageName = this.querySelector('span').textContent;
      navigateToPage(pageId, pageName);
      
      // Set active states
      document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelectorAll('.dropdown-item').forEach(item => {
        item.classList.remove('active');
      });
      
      this.classList.add('active');
    });
  });

  // Create invoice navigation
  createInvoiceBtn.addEventListener('click', function() {
    resetInvoiceForm();
    invoiceFormTitle.textContent = 'Create New Invoice';
    saveInvoiceBtn.innerHTML = '<i class="fas fa-save"></i> Save Invoice';
    isEditMode = false;
    navigateToPage('createInvoicePage', 'Create Invoice');
  });

  createFirstInvoice.addEventListener('click', function(e) {
    e.preventDefault();
    resetInvoiceForm();
    invoiceFormTitle.textContent = 'Create New Invoice';
    saveInvoiceBtn.innerHTML = '<i class="fas fa-save"></i> Save Invoice';
    isEditMode = false;
    navigateToPage('createInvoicePage', 'Create Invoice');
  });

  backToInvoices.addEventListener('click', function() {
    navigateToPage('invoicesPage', 'Invoices');
  });

  // FIXED: Auto-fill email when client name is entered
  document.getElementById('clientName').addEventListener('input', function() {
    const clientName = this.value.trim();
    const emailField = document.getElementById('clientEmail');
    
    // Only auto-fill if we're creating a new invoice (not editing) and email field is empty
    if (!isEditMode && clientName && emailField.value === '') {
      // Convert name to lowercase, replace spaces with dots, remove special characters
      const emailName = clientName.toLowerCase()
        .replace(/\s+/g, '.')
        .replace(/[^a-z0-9.]/g, '');
      emailField.value = emailName + '@gmail.com';
    }
  });

  // Handle delete button click for invoices
  function handleDelete(event) {
    const invoiceId = event.target.closest('.btn-delete').getAttribute('data-id');
    currentInvoiceId = invoiceId;
    deleteModal.style.display = 'flex';
  }

  // Handle edit button click for invoices
  function handleEdit(event) {
    const invoiceId = event.target.closest('.btn-edit').getAttribute('data-id');
    currentInvoiceId = invoiceId;
    isEditMode = true;
    
    // Load invoice data for editing
    loadInvoiceForEdit(invoiceId);
  }

  // Load invoice data for editing
  async function loadInvoiceForEdit(invoiceId) {
    try {
      // Check if Airtable credentials are provided
      if (!AIRTABLE_BASE_ID || !AIRTABLE_API_KEY || 
          AIRTABLE_BASE_ID === "YOUR_BASE_ID" || 
          AIRTABLE_API_KEY === "YOUR_API_KEY") {
        alert('Airtable not configured. Cannot load invoice for editing.');
        return;
      }

      const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}/${invoiceId}`, {
        headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      const invoice = data.fields;
      
      // Populate form with invoice data
      document.getElementById('date').value = invoice.Date || '';
      document.getElementById('validity').value = invoice.Validity || '';
      document.getElementById('companyName').value = invoice['Company Name'] || '';
      document.getElementById('projectName').value = invoice['Project Name'] || '';
      document.getElementById('projectDescription').value = invoice['Project Description'] || '';
      document.getElementById('clientName').value = invoice['Client Name'] || '';
      document.getElementById('clientEmail').value = invoice['Client Email'] || '';
      document.getElementById('clientAddress').value = invoice['Client Address'] || '';
      document.getElementById('paymentTerms').value = invoice['Payment Terms'] || '';
      document.getElementById('deliveryTimeline').value = invoice['Delivery Timeline'] || '';
      document.getElementById('status').value = invoice.Status || 'Draft';
      
      // Set invoice number
      currentInvoiceNumber = invoice['Invoice Number'] || '';
      document.getElementById('invoiceNumberDisplay').textContent = currentInvoiceNumber;
      
      // Populate items table
      const itemsTableBody = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
      itemsTableBody.innerHTML = '';
      
      // Parse items data
      if (invoice['Item Names']) {
        const itemNames = invoice['Item Names'].split(', ');
        const itemDescriptions = invoice['Item Descriptions'].split(', ');
        const itemQtys = invoice['Item Quantities'].split(', ').map(q => parseFloat(q));
        const itemPrices = invoice['Item Prices'].split(', ').map(p => parseFloat(p));
        
        // Handle discounts
        let itemDiscounts = [];
        if (invoice['Item Discounts'] && invoice['Item Discounts'] !== '') {
          if (typeof invoice['Item Discounts'] === 'string') {
            itemDiscounts = invoice['Item Discounts'].split(', ').map(d => parseFloat(d));
          } else {
            itemDiscounts = Array.isArray(invoice['Item Discounts']) 
              ? invoice['Item Discounts'].map(d => parseFloat(d))
              : [parseFloat(invoice['Item Discounts'])];
          }
        } else {
          // If no discounts, create array of zeros
          itemDiscounts = new Array(itemNames.length).fill(0);
        }
        
        // Ensure itemDiscounts has the same length as itemNames
        while (itemDiscounts.length < itemNames.length) {
          itemDiscounts.push(0);
        }
        
        for (let i = 0; i < itemNames.length; i++) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><input type="text" name="itemName[]" value="${itemNames[i] || ''}" required></td>
            <td><input type="text" name="itemDescription[]" value="${itemDescriptions[i] || ''}" required></td>
            <td><input type="number" name="itemQty[]" value="${itemQtys[i] || 1}" min="1" required></td>
            <td><input type="number" name="itemPrice[]" value="${itemPrices[i] || 0}" min="0" step="0.01" required></td>
            <td><input type="number" name="itemDiscount[]" value="${itemDiscounts[i] || 0}" min="0" max="100" step="0.01" required></td>
            <td><input type="number" name="itemTotal[]" value="0" readonly></td>
            <td><button type="button" class="removeBtn"><i class="fas fa-trash"></i></button></td>
          `;
          itemsTableBody.appendChild(row);
        }
      } else {
        // Add at least one empty row
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" name="itemName[]" placeholder="Service name" required></td>
          <td><input type="text" name="itemDescription[]" placeholder="Item description" required></td>
          <td><input type="number" name="itemQty[]" value="1" min="1" required></td>
          <td><input type="number" name="itemPrice[]" value="0" min="0" step="0.01" required></td>
          <td><input type="number" name="itemDiscount[]" value="0" min="0" max="100" step="0.01" required></td>
          <td><input type="number" name="itemTotal[]" value="0" readonly></td>
          <td><button type="button" class="removeBtn"><i class="fas fa-trash"></i></button></td>
        `;
        itemsTableBody.appendChild(row);
      }
      
      // Update form title and button
      invoiceFormTitle.textContent = 'Edit Invoice';
      saveInvoiceBtn.innerHTML = '<i class="fas fa-save"></i> Update Invoice';
      
      // Calculate totals
      calculateTotals();
      
      // Navigate to create invoice page
      navigateToPage('createInvoicePage', 'Edit Invoice');
      
    } catch(error) {
      console.error('Error loading invoice for editing:', error);
      alert('Error loading invoice for editing: ' + error.message);
    }
  }

  // Reset invoice form
  function resetInvoiceForm() {
    document.getElementById('invoiceForm').reset();
    const itemsTableBody = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
    itemsTableBody.innerHTML = `
      <tr>
        <td><input type="text" name="itemName[]" placeholder="Service name" required></td>
        <td><input type="text" name="itemDescription[]" placeholder="Item description" required></td>
        <td><input type="number" name="itemQty[]" value="1" min="1" required></td>
        <td><input type="number" name="itemPrice[]" value="0" min="0" step="0.01" required></td>
        <td><input type="number" name="itemDiscount[]" value="0" min="0" max="100" step="0.01" required></td>
        <td><input type="number" name="itemTotal[]" value="0" readonly></td>
        <td><button type="button" class="removeBtn"><i class="fas fa-trash"></i></button></td>
      </tr>
    `;
    calculateTotals();
    getNextInvoiceNumber();
    currentInvoiceId = null;
    isEditMode = false;
  }

  // Handle delete confirmation
  confirmDelete.addEventListener('click', async function() {
    try {
      // Check if Airtable credentials are provided
      if (!AIRTABLE_BASE_ID || !AIRTABLE_API_KEY || 
          AIRTABLE_BASE_ID === "YOUR_BASE_ID" || 
          AIRTABLE_API_KEY === "YOUR_API_KEY") {
        alert('Invoice deleted locally! (Airtable not configured)');
        deleteModal.style.display = 'none';
        if (currentInvoiceId) {
          loadInvoicesFromAirtable();
        }
        return;
      }

      const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}/${currentInvoiceId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${AIRTABLE_API_KEY}`
        }
      });
      
      if (response.ok) {
        alert('Invoice deleted successfully!');
        deleteModal.style.display = 'none';
        if (currentInvoiceId) {
          loadInvoicesFromAirtable();
          currentInvoiceId = null;
        }
      } else {
        const result = await response.json();
        alert('Error: ' + result.error.message);
      }
    } catch(error) {
      alert('Network error: ' + error.message);
    }
  });

  // Close delete modal
  closeDeleteModal.addEventListener('click', function() {
    deleteModal.style.display = 'none';
  });
  
  cancelDelete.addEventListener('click', function() {
    deleteModal.style.display = 'none';
  });

  // Close modal when clicking outside
  window.addEventListener('click', function(event) {
    if (event.target === deleteModal) {
      deleteModal.style.display = 'none';
    }
  });

  // Load invoices from Airtable
  async function loadInvoicesFromAirtable() {
    const invoicesTableBody = document.getElementById('invoicesTableBody');
    
    try {
      // Check if Airtable credentials are provided
      if (!AIRTABLE_BASE_ID || !AIRTABLE_API_KEY || 
          AIRTABLE_BASE_ID === "YOUR_BASE_ID" || 
          AIRTABLE_API_KEY === "YOUR_API_KEY") {
        invoicesTableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-500);">
              <i class="fas fa-cloud" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
              <p>Airtable not configured. <a href="#" style="color: var(--primary);" id="createFirstInvoice2">Create your first invoice</a></p>
            </td>
          </tr>
        `;
        document.getElementById('createFirstInvoice2').addEventListener('click', function(e) {
          e.preventDefault();
          resetInvoiceForm();
          invoiceFormTitle.textContent = 'Create New Invoice';
          saveInvoiceBtn.innerHTML = '<i class="fas fa-save"></i> Save Invoice';
          isEditMode = false;
          navigateToPage('createInvoicePage', 'Create Invoice');
        });
        return;
      }

      const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?pageSize=100`, {
        headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.records || data.records.length === 0) {
        invoicesTableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-500);">
              <i class="fas fa-file-invoice" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
              <p>No invoices found. <a href="#" style="color: var(--primary);" id="createFirstInvoice3">Create your first invoice</a></p>
            </td>
          </tr>
        `;
        document.getElementById('createFirstInvoice3').addEventListener('click', function(e) {
          e.preventDefault();
          resetInvoiceForm();
          invoiceFormTitle.textContent = 'Create New Invoice';
          saveInvoiceBtn.innerHTML = '<i class="fas fa-save"></i> Save Invoice';
          isEditMode = false;
          navigateToPage('createInvoicePage', 'Create Invoice');
        });
        return;
      }

      // Populate table with invoices
      invoicesTableBody.innerHTML = data.records.map(record => {
        const fields = record.fields;
        const statusClass = `status-${fields.Status?.toLowerCase() || 'draft'}`;
        
        return `
          <tr>
            <td><strong>${fields['Invoice Number'] || 'N/A'}</strong></td>
            <td>${fields['Client Name'] || 'N/A'}</td>
            <td>${fields.Date || 'N/A'}</td>
            <td><strong>RM ${fields.Total || '0.00'}</strong></td>
            <td><span class="status-badge ${statusClass}">${fields.Status || 'Draft'}</span></td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-edit" data-id="${record.id}">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-sm btn-delete" data-id="${record.id}">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      // Add event listeners to edit and delete buttons
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', handleEdit);
      });
      
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', handleDelete);
      });
      
    } catch(error) {
      console.error('Error loading invoices:', error);
      invoicesTableBody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align: center; padding: 40px; color: var(--gray-500);">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
            <p>Error loading invoices. <a href="#" style="color: var(--primary);" id="createFirstInvoice4">Create your first invoice</a></p>
          </td>
        </tr>
      `;
      document.getElementById('createFirstInvoice4').addEventListener('click', function(e) {
        e.preventDefault();
        resetInvoiceForm();
        invoiceFormTitle.textContent = 'Create New Invoice';
        saveInvoiceBtn.innerHTML = '<i class="fas fa-save"></i> Save Invoice';
        isEditMode = false;
        navigateToPage('createInvoicePage', 'Create Invoice');
      });
    }
  }

  // Invoice form functionality
  const invoiceForm = document.getElementById('invoiceForm');
  const addItemBtn = document.getElementById('addItem');
  const itemsTable = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
  const invoiceNumberDisplay = document.getElementById('invoiceNumberDisplay');

  // Dynamic items & totals with discount
  function calculateTotals() {
    let subtotal = 0;
    let totalDiscount = 0;
    const rows = itemsTable.querySelectorAll('tr');
    
    rows.forEach(row => {
      const qty = parseFloat(row.querySelector('input[name="itemQty[]"]').value) || 0;
      const price = parseFloat(row.querySelector('input[name="itemPrice[]"]').value) || 0;
      const discount = parseFloat(row.querySelector('input[name="itemDiscount[]"]').value) || 0;
      
      const itemSubtotal = qty * price;
      const itemDiscountAmount = itemSubtotal * (discount / 100);
      const itemTotal = itemSubtotal - itemDiscountAmount;
      
      row.querySelector('input[name="itemTotal[]"]').value = itemTotal.toFixed(2);
      subtotal += itemSubtotal;
      totalDiscount += itemDiscountAmount;
    });

    document.getElementById('subtotalDisplay').textContent = 'RM ' + subtotal.toFixed(2);
    document.getElementById('totalDiscountDisplay').textContent = 'RM ' + totalDiscount.toFixed(2);
    
    const taxableAmount = subtotal - totalDiscount;
    const tax = +(taxableAmount * 0.06).toFixed(2);
    document.getElementById('taxDisplay').textContent = 'RM ' + tax.toFixed(2);
    document.getElementById('totalDisplay').textContent = 'RM ' + (taxableAmount + tax).toFixed(2);
  }

  // Add new item row
  addItemBtn.addEventListener('click', () => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" name="itemName[]" placeholder="Service name" required></td>
      <td><input type="text" name="itemDescription[]" placeholder="Item description" required></td>
      <td><input type="number" name="itemQty[]" min="1" value="1" required></td>
      <td><input type="number" name="itemPrice[]" min="0" step="0.01" value="0" placeholder="0.00" required></td>
      <td><input type="number" name="itemDiscount[]" value="0" min="0" max="100" step="0.01" placeholder="0.00" required></td>
      <td><input type="number" name="itemTotal[]" value="0" readonly></td>
      <td><button type="button" class="removeBtn"><i class="fas fa-trash"></i></button></td>
    `;
    itemsTable.appendChild(row);
    calculateTotals();
  });

  // Remove item row
  itemsTable.addEventListener('click', function(e){
    if(e.target.closest('.removeBtn')){
      if(itemsTable.querySelectorAll('tr').length > 1) {
        e.target.closest('tr').remove();
        calculateTotals();
      } else {
        alert('You need at least one item in the invoice.');
      }
    }
  });

  // Calculate totals when inputs change
  itemsTable.addEventListener('input', calculateTotals);
  
  // Initialize with default values
  calculateTotals();
  
  // Get next invoice number on page load
  getNextInvoiceNumber();

  // Next Invoice Number (consecutive)
  async function getNextInvoiceNumber() {
    try {
      // Check if Airtable credentials are provided
      if (!AIRTABLE_BASE_ID || !AIRTABLE_API_KEY || 
          AIRTABLE_BASE_ID === "YOUR_BASE_ID" || 
          AIRTABLE_API_KEY === "YOUR_API_KEY") {
        console.warn('Airtable credentials not configured. Using default invoice number.');
        invoiceNumberDisplay.textContent = 'MOZ-001';
        return 'MOZ-001';
      }

      const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?pageSize=100`, {
        headers: { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      // Check if data.records exists and is an array
      if (!data.records || !Array.isArray(data.records)) {
        console.warn('No records found or invalid response structure. Using default invoice number.');
        invoiceNumberDisplay.textContent = 'MOZ-001';
        return 'MOZ-001';
      }
      
      const existingNumbers = data.records.map(r => {
        // Safely access the invoice number field
        const invoiceNum = r.fields ? r.fields['Invoice Number'] : null;
        if (invoiceNum && invoiceNum.startsWith('MOZ-')) {
          const num = invoiceNum.split('-')[1];
          return num ? parseInt(num) : 0;
        }
        return 0;
      }).filter(n => !isNaN(n) && n > 0).sort((a,b) => a - b);
      
      let nextNum = 1;
      for (let n of existingNumbers) {
        if (n === nextNum) nextNum++; 
        else break;
      }
      
      const invoiceNumber = `MOZ-${String(nextNum).padStart(3,'0')}`;
      invoiceNumberDisplay.textContent = invoiceNumber;
      return invoiceNumber;
      
    } catch(e){ 
      console.error('Error fetching invoice number:', e); 
      // Fallback to a default number
      invoiceNumberDisplay.textContent = 'MOZ-001';
      return 'MOZ-001'; 
    }
  }

  // Submit invoice to Airtable - FIXED VERSION
  invoiceForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const invoiceNumber = isEditMode ? currentInvoiceNumber : await getNextInvoiceNumber();

    // Gather items
    const itemNames = [...document.getElementsByName('itemName[]')].map(i => i.value);
    const itemDescriptions = [...document.getElementsByName('itemDescription[]')].map(i => i.value);
    const itemQtys = [...document.getElementsByName('itemQty[]')].map(i => parseFloat(i.value));
    const itemPrices = [...document.getElementsByName('itemPrice[]')].map(i => parseFloat(i.value));
    const itemDiscounts = [...document.getElementsByName('itemDiscount[]')].map(i => parseFloat(i.value));

    const subtotal = parseFloat(document.getElementById('subtotalDisplay').textContent.replace('RM ', ''));
    const totalDiscount = parseFloat(document.getElementById('totalDiscountDisplay').textContent.replace('RM ', ''));
    const tax = parseFloat(document.getElementById('taxDisplay').textContent.replace('RM ', ''));
    const total = parseFloat(document.getElementById('totalDisplay').textContent.replace('RM ', ''));

    // Create invoice data with correct field names
    const invoiceData = {
      fields: {
        "Date": invoiceForm.date.value,
        "Invoice Number": invoiceNumber,
        "Validity": invoiceForm.validity.value,
        "Company Name": invoiceForm.companyName.value,
        "Client Name": invoiceForm.clientName.value,
        "Client Email": invoiceForm.clientEmail.value, // Fixed field name
        "Client Address": invoiceForm.clientAddress.value, // Fixed field name
        "Project Name": invoiceForm.projectName.value,
        "Project Description": invoiceForm.projectDescription.value,
        "Item Names": itemNames.join(", "),
        "Item Descriptions": itemDescriptions.join(", "),
        "Item Quantities": itemQtys.join(", "),
        "Item Prices": itemPrices.join(", "),
        "Item Discounts": itemDiscounts.join(", "),
        "Subtotal": subtotal,
        "Discount": totalDiscount,
        "Tax": tax,
        "Total": total,
        "Payment Terms": invoiceForm.paymentTerms.value,
        "Delivery Timeline": invoiceForm.deliveryTimeline.value,
        "Status": invoiceForm.status.value
      }
    };

    console.log("Sending invoice data:", invoiceData);

    try {
      // Check if Airtable credentials are provided before trying to save
      if (!AIRTABLE_BASE_ID || !AIRTABLE_API_KEY || 
          AIRTABLE_BASE_ID === "YOUR_BASE_ID" || 
          AIRTABLE_API_KEY === "YOUR_API_KEY") {
        alert(`Invoice ${invoiceNumber} ${isEditMode ? 'updated' : 'created'} locally! (Airtable not configured)`);
        resetInvoiceForm();
        navigateToPage('invoicesPage', 'Invoices');
        return;
      }

      const url = isEditMode 
        ? `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}/${currentInvoiceId}`
        : `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
      
      const method = isEditMode ? 'PATCH' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(invoiceData)
      });
      
      const result = await response.json();
      console.log("Airtable response:", result);
      
      if(response.ok){ 
        alert(`Invoice ${invoiceNumber} ${isEditMode ? 'updated' : 'saved'} to Airtable!`); 
        resetInvoiceForm();
        navigateToPage('invoicesPage', 'Invoices');
        loadInvoicesFromAirtable(); // Refresh the list
      } 
      else {
        alert('Error: '+ result.error.message);
      }
    } catch(error){ 
      console.error("Network error:", error);
      alert('Network error: '+error.message); 
    }
  });

  document.getElementById('downloadPdf').addEventListener('click', ()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p","pt","a4");

    let y = 40;

    // Title
    doc.setFontSize(22);
    doc.setFont("helvetica","bold");
    doc.text("INVOICE", 300, y, {align:"center"});
    y += 40;

    // Separator
    doc.setLineWidth(1);
    doc.line(40, y, 555, y);
    y += 25;

    doc.setFontSize(12);
    doc.setFont("helvetica","");

    doc.text(`Date: ${invoiceForm.date.value}`, 40, y); y += 18;
    doc.text(`Invoice Number: ${invoiceNumberDisplay.textContent}`, 40, y); y += 18;
    doc.text(`Validity: ${invoiceForm.validity.value}`, 40, y); y += 18;
    doc.text(`Company Name: ${invoiceForm.companyName.value}`, 40, y); y += 30;

    doc.setFont("helvetica","bold");
    doc.text("Client Details", 40, y); y += 15;
    doc.setFont("helvetica","");
    doc.text(`Name: ${invoiceForm.clientName.value}`, 40, y); y += 15;
    doc.text(`Email: ${invoiceForm.clientEmail.value}`, 40, y); y += 15;
    doc.text(`Address: ${invoiceForm.clientAddress.value}`, 40, y); y += 30;

    doc.setFont("helvetica","bold");
    doc.text("Project Details", 40, y); y += 15;
    doc.setFont("helvetica","");
    doc.text(`Project Name: ${invoiceForm.projectName.value}`, 40, y); y += 15;
    doc.text(`Description: ${invoiceForm.projectDescription.value}`, 40, y); y += 30;

    // ITEMS TABLE
    doc.setFont("helvetica","bold");
    doc.text("Items", 40, y); y += 20;

    doc.setFontSize(11);

    const rows = itemsTable.querySelectorAll('tr');

    rows.forEach((row,i)=>{
      doc.setFont("helvetica","bold");
      doc.text(`Item ${i+1}`, 40, y);
      y += 14;

      doc.setFont("helvetica","");
      doc.text(`Service: ${row.querySelector('input[name="itemName[]"]').value}`, 55, y); y += 14;
      doc.text(`Description: ${row.querySelector('input[name="itemDescription[]"]').value}`, 55, y); y += 14;
      const discount = row.querySelector('input[name="itemDiscount[]"]').value;
      if (discount > 0) {
        doc.text(`Qty: ${row.querySelector('input[name="itemQty[]"]').value} | Price: RM ${row.querySelector('input[name="itemPrice[]"]').value} | Discount: ${discount}% | Total: RM ${row.querySelector('input[name="itemTotal[]"]').value}`, 55, y);
      } else {
        doc.text(`Qty: ${row.querySelector('input[name="itemQty[]"]').value} | Price: RM ${row.querySelector('input[name="itemPrice[]"]').value} | Total: RM ${row.querySelector('input[name="itemTotal[]"]').value}`, 55, y);
      }
      y += 22;

      doc.setLineWidth(0.5);
      doc.line(40, y, 555, y);
      y += 12;
    });

    y += 15;
    doc.setFontSize(12);
    doc.setFont("helvetica","bold");
    doc.text("Summary", 40, y); y += 18;

    doc.setFont("helvetica","");
    doc.text(`Subtotal: ${document.getElementById('subtotalDisplay').textContent}`, 40, y); y += 16;
    doc.text(`Discount: ${document.getElementById('totalDiscountDisplay').textContent}`, 40, y); y += 16;
    doc.text(`Tax (6%): ${document.getElementById('taxDisplay').textContent}`, 40, y); y += 16;
    doc.setFont("helvetica","bold");
    doc.text(`TOTAL: ${document.getElementById('totalDisplay').textContent}`, 40, y);

    doc.save(`Invoice-${invoiceForm.clientName.value}.pdf`);
  });

  // Start with Invoices page active
  navigateToPage('invoicesPage', 'Invoices');
});
</script>

</body>
</html>